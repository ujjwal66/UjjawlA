Selector=function(n){var t=this;t.drawningboard=n;t.width=0;t.height=0;t.target=[];t.explodedtarget=[];t.contextmenu;t.selector=[];t.selector.bg=t.drawningboard.workspace.g();t.selector.bg.addClass("selector-part");t.selector.lowergroup=t.drawningboard.workspace.g();t.selector.lowergroup.addClass("selector-part");t.selector.uppergroup=t.drawningboard.workspace.g();t.selector.uppergroup.addClass("selector-part");t.selector.multigroup=t.drawningboard.workspace.g();t.selector.multigroup.addClass("selector-part");t.selector.multiarea=t.selector.multigroup.rect(0,0,0,0);t.selector.highlightgroup=t.drawningboard.workspace.g();t.selector.highlight=t.selector.highlightgroup.rect(0,0,0,0);t.multicoords;t.scalex=1;t.scaley=1;t.x=0;t.y=0;t.rotation=0;t.reshapeheight=0;t.dragging=!1;t.scaling=!1;t.rotating=!1;t.reshaping=!1;t.contextaction=!1;t.explodedmode=!1;t.deleting=!1;t.hovering=!1;t.selected=!1;t.multiselection=!1;t.displaycontrols=!0;t.moveselected=!1;t.lastclick=new Date;t.rotate;t.relativeset=0;t.selectionborderw=5;t.selectionborderh=5;t.pixellimit=40;t.changed=0;t.unselectimer;t.contentcolor="#2390BB";t.fillcolor="rgba(255, 255, 255, 0)";t.bgfillcolor="rgba(255, 255, 255, 0)";t.cornersfillcolor="rgba(255, 255, 255, 1)";t.multifillcolor="rgba(168, 202, 236, 0.5)";t.highlightcolor="rgba(255, 136, 0, 0.1)";t.highlightbordercolor="rgb(255, 136, 0)";t.curvedfillcolor="rgba(255, 0, 0, 1)";t.bordercolor="#2390BB";t.multibordercolor="#3399FF";t.rotateimage="Content/img/Rotate-big.svg";t.strokestyle=2;t.multistrokestyle=1;t.cornerssize=t.drawningboard.isIOS?10:7;t.debug=!1;t.debugger=[];t.copytarget=[];t.colorcopytarget;t.pastecount;t.rotatetip=$("#selectorRotatetip");t.start=function(){t.startelements();t.backwatch()};t.finish=function(){t.selector.lowergroup.clear();t.selector.uppergroup.clear()};t.startelements=function(){t.selector.base=t.selector.lowergroup.rect(0,0,0,0).attr({fill:t.fillcolor,cursor:"move"});t.selector.border=t.selector.uppergroup.rect(0,0,0,0).attr({fill:"none","stroke-width":t.strokestyle,stroke:t.bordercolor});t.selector.highlight.attr({fill:t.highlightcolor,"stroke-width":t.multistrokestyle,stroke:t.highlightbordercolor});t.selector.rotate=t.selector.uppergroup.g();t.selector.rotate.attr({transform:"scale(0.5, 0.5)"});t.selector.rotateline=t.selector.uppergroup.rect(0,-21,1,21).attr({fill:t.fillcolor,"stroke-width":1,stroke:t.bordercolor,cursor:"pointer"});Snap.load(t.rotateimage,function(n){t.selector.rotate.add(n.select("svg"));t.selector.rotate.selectAll("path").attr({fill:t.contentcolor});t.selector.rotate.select("svg").attr({y:"-71px",cursor:"pointer",x:0});t.selector.rotate.select("svg").circle(14.5,0,15).attr({fill:"transparent"})});t.selector.circle_se=t.selector.uppergroup.circle(0,0,0);t.selector.circle_se.name="se";t.selector.circle_se.number="4";t.selector.circle_se.type="corner";t.selector.circle_se.affectedby="regular";t.selector.circle_se.angle=135;t.selector.circle_se.xfactor=1;t.selector.circle_se.yfactor=1;t.selector.circle_sw=t.selector.uppergroup.circle(0,0,0);t.selector.circle_sw.name="sw";t.selector.circle_sw.number="2";t.selector.circle_sw.type="corner";t.selector.circle_sw.affectedby="regular";t.selector.circle_sw.angle=225;t.selector.circle_sw.xfactor=0;t.selector.circle_sw.yfactor=1;t.selector.circle_ne=t.selector.uppergroup.circle(0,0,0);t.selector.circle_ne.name="ne";t.selector.circle_ne.number="3";t.selector.circle_ne.type="corner";t.selector.circle_ne.affectedby="regular";t.selector.circle_ne.angle=45;t.selector.circle_ne.xfactor=1;t.selector.circle_ne.yfactor=0;t.selector.circle_nw=t.selector.uppergroup.circle(0,0,0);t.selector.circle_nw.name="nw";t.selector.circle_nw.number="1";t.selector.circle_nw.type="corner";t.selector.circle_nw.affectedby="regular";t.selector.circle_nw.angle=315;t.selector.circle_nw.xfactor=0;t.selector.circle_nw.yfactor=0;t.selector.circle_s=t.selector.uppergroup.circle(0,0,0);t.selector.circle_s.name="s";t.selector.circle_s.number="5";t.selector.circle_s.type="vertical";t.selector.circle_s.affectedby="vertical";t.selector.circle_s.angle=180;t.selector.circle_s.xfactor=.5;t.selector.circle_s.yfactor=1;t.selector.circle_n=t.selector.uppergroup.circle(0,0,0);t.selector.circle_n.name="n";t.selector.circle_n.number="6";t.selector.circle_n.type="vertical";t.selector.circle_n.affectedby="vertical";t.selector.circle_n.angle=0;t.selector.circle_n.xfactor=.5;t.selector.circle_n.yfactor=0;t.selector.circle_w=t.selector.uppergroup.circle(0,0,0);t.selector.circle_w.name="w";t.selector.circle_w.number="7";t.selector.circle_w.type="horizontal";t.selector.circle_w.affectedby="horizontal";t.selector.circle_w.angle=270;t.selector.circle_w.xfactor=0;t.selector.circle_w.yfactor=.5;t.selector.circle_e=t.selector.uppergroup.circle(0,0,0);t.selector.circle_e.name="e";t.selector.circle_e.number="8";t.selector.circle_e.type="horizontal";t.selector.circle_e.affectedby="horizontal";t.selector.circle_e.angle=90;t.selector.circle_e.xfactor=1;t.selector.circle_e.yfactor=.5;$.each([t.selector.circle_se,t.selector.circle_sw,t.selector.circle_ne,t.selector.circle_nw,t.selector.circle_s,t.selector.circle_n,t.selector.circle_w,t.selector.circle_e],function(n,i){i.attr({fill:t.cornersfillcolor,"stroke-width":t.strokestyle,stroke:t.bordercolor})});t.selector.path=t.selector.uppergroup.path();t.selector.path.attr({"stroke-width":3,stroke:t.curvedfillcolor,fill:"none"});t.selector.curvedpathleft=t.selector.uppergroup.line(0,0,0,0).attr({fill:t.fillcolor,"stroke-width":1,stroke:t.bordercolor});t.selector.curvedpathright=t.selector.uppergroup.line(0,0,0,0).attr({fill:t.fillcolor,"stroke-width":1,stroke:t.bordercolor});t.selector.curvedleft=t.selector.uppergroup.circle(0,0,0);t.selector.curvedleft.name="left";t.selector.curvedanchorleft=t.selector.uppergroup.circle(0,0,0);t.selector.curvedanchorleft.name="anchorleft";t.selector.curvedanchorright=t.selector.uppergroup.circle(0,0,0);t.selector.curvedanchorright.name="anchorright";t.selector.curvedright=t.selector.uppergroup.circle(0,0,0);t.selector.curvedright.name="right";$.each([t.selector.curvedleft,t.selector.curvedright,t.selector.curvedanchorleft,t.selector.curvedanchorright],function(n,i){i.attr({fill:t.curvedfillcolor,"stroke-width":t.strokestyle,stroke:t.bordercolor,cursor:"pointer"})});t.selector.curvedanchorleft.attr("fill","orange");t.selector.curvedanchorright.attr("fill","orange");t.selector.multiarea.attr({fill:t.multifillcolor,"stroke-width":t.multistrokestyle,stroke:t.multibordercolor});t.selector.background=t.selector.bg.rect(0,0,t.drawningboard.width,t.drawningboard.height);t.selector.background.attr({fill:t.bgfillcolor});$(t.selector.background.node).css({transition:"0.6s","-webkit-transition":"0.6s","-moz-transition":"0.6s","-0-transition":"0.6s"});t.selector.lowergroup.mousedown(function(){var n=t.target,i=n.length===1?n[0]:null;i&&!t.selected?t.select([i],!0):n.length>1&&t.select(n,!0)});t.selector.context=t.selector.uppergroup.g();t.selector.contextbuttom=t.selector.context.rect(0,0,30,30);t.selector.context.attr({cursor:"pointer",visibility:"hidden"});t.selector.contextbuttom.attr({fill:t.contentcolor,rx:5,ry:5});t.selector.context.rect(6,6,18,4).attr({fill:"white"});t.selector.context.rect(6,13,18,4).attr({fill:"white"});t.selector.context.rect(6,20,18,4).attr({fill:"white"});t.debug&&(t.debugger.d1=t.drawningboard.workspace.circle(0,0,7),t.debugger.d2=t.drawningboard.workspace.circle(0,0,7),t.debugger.d3=t.drawningboard.workspace.circle(0,0,7),t.debugger.d4=t.drawningboard.workspace.circle(0,0,7),t.debugger.d5=t.drawningboard.workspace.circle(0,0,7),t.debugger.d1t=t.drawningboard.workspace.text(0,0,"d1"),t.debugger.d2t=t.drawningboard.workspace.text(0,0,"d2"),t.debugger.d3t=t.drawningboard.workspace.text(0,0,"d3"),t.debugger.d4t=t.drawningboard.workspace.text(0,0,"d4"),t.debugger.d5t=t.drawningboard.workspace.text(0,0,"d5"))};t.update=function(){t.multiselection?(t.updateselector(!1),t.updatemultiselector(!0),t.drawningboard.informationtab.update()):t.target.length>0?(t.updatemultiselector(!1),t.updateselector(!0),t.drawningboard.informationtab.update()):(t.updatemultiselector(!1),t.updateselector(!1))};t.updatemultiselector=function(n){n?t.selector.multiarea.attr({x:t.x,y:t.y,width:t.width,height:t.height}):t.selector.multiarea.attr({width:0,height:0})};t.updateselector=function(n){n?(t.selector.lowergroup.attr({transform:"translate("+parseInt(t.x-t.width/2)+","+parseInt(t.y-t.height/2)+") rotate("+calc.fixDegree(t.rotation)+" "+t.width/2+" "+t.height/2+") "}),t.selector.uppergroup.attr({transform:"translate("+parseInt(t.x-t.width/2)+","+parseInt(t.y-t.height/2)+") rotate("+calc.fixDegree(t.rotation)+" "+t.width/2+" "+t.height/2+") "}),t.reshaping||(t.selector.base.attr({width:t.width+"px",height:t.height+"px"}),t.selector.border.attr({width:t.width+"px",height:t.height+"px"})),t.selected&&!t.reshaping&&(t.drawningboard.ownermode&&t.drawningboard.selector.targethavecompanytext()||(t.selector.rotate.select("svg").attr({x:(t.width/2-7.25)*2}),t.selector.rotate.selectAll("path").attr({fill:"#2390BB"}),t.selector.rotateline.attr({x:t.width/2,width:1}))),t.selected&&t.target.length==1&&t.target[0]instanceof Text&&t.target[0].curvedline.enabled&&!t.scaling?(t.selector.curvedleft.attr({cx:t.selector.curvedleft.x,cy:t.selector.curvedleft.y,r:t.cornerssize}),t.selector.curvedanchorleft.attr({cx:t.selector.curvedanchorleft.x,cy:t.selector.curvedanchorleft.y,r:t.cornerssize}),t.selector.curvedanchorright.attr({cx:t.selector.curvedanchorright.x,cy:t.selector.curvedanchorright.y,r:t.cornerssize}),t.selector.curvedright.attr({cx:t.selector.curvedright.x,cy:t.selector.curvedright.y,r:t.cornerssize}),t.selector.path.attr({d:"M"+t.selector.curvedleft.attr("cx")+","+t.selector.curvedleft.attr("cy")+" C"+t.selector.curvedanchorleft.attr("cx")+","+t.selector.curvedanchorleft.attr("cy")+" "+t.selector.curvedanchorright.attr("cx")+","+t.selector.curvedanchorright.attr("cy")+" "+t.selector.curvedright.attr("cx")+","+t.selector.curvedright.attr("cy")}),t.selector.curvedpathleft.attr({x1:t.selector.curvedleft.attr("cx"),y1:t.selector.curvedleft.attr("cy"),x2:t.selector.curvedanchorleft.attr("cx"),y2:t.selector.curvedanchorleft.attr("cy")}),t.selector.curvedpathright.attr({x1:t.selector.curvedright.attr("cx"),y1:t.selector.curvedright.attr("cy"),x2:t.selector.curvedanchorright.attr("cx"),y2:t.selector.curvedanchorright.attr("cy")})):t.scaling&&($.each([t.selector.curvedleft,t.selector.curvedanchorleft,t.selector.curvedanchorright,t.selector.curvedright],function(n,t){t.attr({r:0})}),t.selector.path.attr({d:""}),t.selector.curvedpathleft.attr({x1:0,y1:0,x2:0,y2:0}),t.selector.curvedpathright.attr({x1:0,y1:0,x2:0,y2:0})),t.displaycontrols&&!t.reshaping&&$.each([t.selector.circle_se,t.selector.circle_sw,t.selector.circle_ne,t.selector.circle_nw,t.selector.circle_s,t.selector.circle_n,t.selector.circle_w,t.selector.circle_e],function(n,i){i.attr({cx:Math.ceil(t.width*i.xfactor),cy:Math.ceil(t.height*i.yfactor),r:t.cornerssize})}),t.rotation>=45&&t.rotation<135?(t.selector.circle_se.attr({cursor:"sw-resize"}),t.selector.circle_sw.attr({cursor:"nw-resize"}),t.selector.circle_ne.attr({cursor:"se-resize"}),t.selector.circle_nw.attr({cursor:"ne-resize"}),t.selector.circle_se.affectedby="flipped",t.selector.circle_sw.affectedby="flipped",t.selector.circle_ne.affectedby="flipped",t.selector.circle_nw.affectedby="flipped",t.selector.circle_n.attr({cursor:"e-resize"}),t.selector.circle_s.attr({cursor:"w-resize"}),t.selector.circle_w.attr({cursor:"n-resize"}),t.selector.circle_e.attr({cursor:"s-resize"}),t.selector.circle_n.affectedby="horizontal",t.selector.circle_s.affectedby="horizontal",t.selector.circle_w.affectedby="vertical",t.selector.circle_e.affectedby="vertical"):t.rotation>=135&&t.rotation<225?(t.selector.circle_se.attr({cursor:"nw-resize"}),t.selector.circle_sw.attr({cursor:"ne-resize"}),t.selector.circle_ne.attr({cursor:"sw-resize"}),t.selector.circle_nw.attr({cursor:"se-resize"}),t.selector.circle_se.affectedby="regular",t.selector.circle_sw.affectedby="regular",t.selector.circle_ne.affectedby="regular",t.selector.circle_nw.affectedby="regular",t.selector.circle_n.attr({cursor:"s-resize"}),t.selector.circle_s.attr({cursor:"n-resize"}),t.selector.circle_w.attr({cursor:"e-resize"}),t.selector.circle_e.attr({cursor:"w-resize"}),t.selector.circle_n.affectedby="vertical",t.selector.circle_s.affectedby="vertical",t.selector.circle_w.affectedby="horizontal",t.selector.circle_e.affectedby="horizontal"):t.rotation>=225&&t.rotation<315?(t.selector.circle_se.attr({cursor:"ne-resize"}),t.selector.circle_sw.attr({cursor:"se-resize"}),t.selector.circle_ne.attr({cursor:"nw-resize"}),t.selector.circle_nw.attr({cursor:"sw-resize"}),t.selector.circle_se.affectedby="flipped",t.selector.circle_sw.affectedby="flipped",t.selector.circle_ne.affectedby="flipped",t.selector.circle_nw.affectedby="flipped",t.selector.circle_n.attr({cursor:"w-resize"}),t.selector.circle_s.attr({cursor:"e-resize"}),t.selector.circle_w.attr({cursor:"s-resize"}),t.selector.circle_e.attr({cursor:"n-resize"}),t.selector.circle_n.affectedby="horizontal",t.selector.circle_s.affectedby="horizontal",t.selector.circle_w.affectedby="vertical",t.selector.circle_e.affectedby="vertical"):(t.selector.circle_se.attr({cursor:"se-resize"}),t.selector.circle_sw.attr({cursor:"sw-resize"}),t.selector.circle_ne.attr({cursor:"ne-resize"}),t.selector.circle_nw.attr({cursor:"nw-resize"}),t.selector.circle_se.affectedby="regular",t.selector.circle_sw.affectedby="regular",t.selector.circle_ne.affectedby="regular",t.selector.circle_nw.affectedby="regular",t.selector.circle_n.attr({cursor:"n-resize"}),t.selector.circle_s.attr({cursor:"s-resize"}),t.selector.circle_w.attr({cursor:"w-resize"}),t.selector.circle_e.attr({cursor:"e-resize"}),t.selector.circle_n.affectedby="vertical",t.selector.circle_s.affectedby="vertical",t.selector.circle_w.affectedby="horizontal",t.selector.circle_e.affectedby="horizontal"),t.drawningboard.workspace.add(t.selector.uppergroup)):(t.selector.base.attr({width:0,height:0}),t.selector.border.attr({width:0,height:0}),t.selector.context.attr({transform:"translate("+(t.width-50)+",-15)",opacity:0}),t.selector.rotate.selectAll("path").attr({fill:"transparent"}),t.selector.rotateline.attr({width:0}),$.each([t.selector.circle_se,t.selector.circle_sw,t.selector.circle_ne,t.selector.circle_nw,t.selector.circle_s,t.selector.circle_n,t.selector.circle_w,t.selector.circle_e,t.selector.curvedleft,t.selector.curvedanchorleft,t.selector.curvedanchorright,t.selector.curvedright],function(n,t){t.attr({r:0})}),t.selector.path.attr({d:""}),t.selector.curvedpathleft.attr({x1:0,y1:0,x2:0,y2:0}),t.selector.curvedpathright.attr({x1:0,y1:0,x2:0,y2:0}))};t.highlight=function(n){var i=t.getclipdata(n);t.selector.highlight.attr({x:i.x1,y:i.y1,width:i.width,height:i.height})};t.unhighlight=function(){t.selector.highlight.attr({width:0,height:0})};t.select=function(n,i){(t.unhighlight(),t.multiselection)||(clearTimeout(t.unselectimer),t.unselect(),t.target=n,i&&(t.selected=i,t.drawningboard.contexttab.select(n),t.drawningboard.informationtab.select(n),t.drawningboard.alignbar.select(n)),t.gettargetdata(),t.update())};t.save=function(){t.relativeset=0;t.changed==1&&(t.changed=0,t.drawningboard.flowtab.pushstate())};t.unselect=function(){t.drawningboard.contexttab.select(null);t.drawningboard.informationtab.select(null);t.drawningboard.alignbar.select(null);t.selected=!1;t.hovering=!1;t.relativeset=0;$.each(t.target,function(n,t){t.update()});t.target=[];t.x=0;t.y=0;t.width=0;t.height=0;t.rotation=0;t.closetips();t.closecontext();t.updatemultiselector(!1);t.updateselector(!1)};t.startexplodedmode=function(n){t.explodedmode=!0;t.explodedtarget=[];t.selector.background.attr({fill:"rgba(255,255,255,0.8)"});$.each(t.retrievegroupelements(n),function(n,i){i.bg&&i.bg.attr({width:0,height:0});t.drawningboard.workspace.add(i.group);t.explodedtarget.push(i)});var i=t.target[0];t.unselect();n==undefined?(t.target=[i],t.select(t.target,!0)):(t.target=[n],t.select(t.target,!0));t.refreshindex()};t.redrawbg=function(){t.selector.background.attr({width:t.drawningboard.width,height:t.drawningboard.height})};t.endexplodedmode=function(){t.explodedmode&&(t.explodedmode=!1,t.selector.background.attr({fill:t.bgfillcolor}),t.drawningboard.toolbar.enable(),$.each(t.drawningboard.cliplist,function(n,t){t.bg&&t.bg.attr({width:t.width,height:t.height})}),t.refreshindex())};t.targethavecompanytext=function(){var n=!1;return $.each(t.target,function(t,i){i.companytext&&(n=!0)}),n};t.targetisgroup=function(n){var i=!0,r=undefined;return n?n instanceof Array||(n=[n]):n=t.target,t.retrievegroupelements(n[0]).length<2&&(i=!1),$.each(n,function(n,t){r==undefined?r=t.groupid:t.groupid!=r&&(i=!1)}),i};t.targetisicon=function(n){var i=!0,r=undefined;return n?n instanceof Array||(n=[n]):n=t.target,t.retrieveiconelements(n[0]).length<2&&(i=!1),$.each(n,function(n,t){r==undefined?r=t.id:t.id!=r&&(i=!1)}),i};t.clipisicon=function(n){return t.retrieveiconelements(n).length>1?!0:!1};t.clipisgroup=function(n){return t.retrievegroupelements(n).length>1?!0:!1};t.closetips=function(){$(".rotatetip:not(#selectorRotatetip)").remove()};t.closecontext=function(){t.contextmenu&&t.contextmenu.finish()};t.checkoverlap=function(n){var i=t.clipisgroup(n)&&!t.explodedmode?t.getgroupcoords(n):t.getrotatedcoords(n);var r=calc.valueInRange(t.x,i.x1,i.x4)||calc.valueInRange(t.x+t.width,i.x1,i.x4)||calc.valueInRange(i.x1,t.x,t.x+t.width)||calc.valueInRange(i.x4,t.x,t.x+t.width),u=calc.valueInRange(t.y,i.y1,i.y4)||calc.valueInRange(t.y+t.height,i.y1,i.y4)||calc.valueInRange(i.y1,t.y,t.y+t.height)||calc.valueInRange(i.y4,t.y,t.y+t.height),f=n.alpha>0;return r&&u&&f&&t.x!=0&&t.y!=0};t.getcoords=function(n){return{x1:n.x-n.width*n.scalex*.5,y1:n.y-n.height*n.scaley*.5,x2:n.x-n.width*n.scalex*.5,y2:n.y+n.height*n.scaley*.5,x3:n.x+n.width*n.scalex*.5,y3:n.y-n.height*n.scaley*.5,x4:n.x+n.width*n.scalex*.5,y4:n.y+n.height*n.scaley*.5,xc:n.x,yc:n.y}};t.getgroupcoords=function(n){var i=t.drawningboard.width,r=t.drawningboard.height,u=0,f=0;return $.each(t.retrievegroupelements(n),function(n,e){var o=t.getrotatedcoords(e),s=[];s.push({x:o.x1,y:o.y1});s.push({x:o.x2,y:o.y2});s.push({x:o.x3,y:o.y3});s.push({x:o.x4,y:o.y4});$.each(s,function(n,t){t.x<i&&(i=t.x);t.y<r&&(r=t.y);t.x>u&&(u=t.x);t.y>f&&(f=t.y)})}),{x1:i,y1:r,x2:i,y2:f,x3:u,y3:r,x4:u,y4:f,xc:i+(u-i)/2,yc:r+(f-r)/2}};t.geticoncoords=function(n){var i=t.drawningboard.width,r=t.drawningboard.height,u=0,f=0;return $.each(t.retrieveiconelements(n),function(n,e){var o=t.getrotatedcoords(e),s=[];s.push({x:o.x1,y:o.y1});s.push({x:o.x2,y:o.y2});s.push({x:o.x3,y:o.y3});s.push({x:o.x4,y:o.y4});$.each(s,function(n,t){t.x<i&&(i=t.x);t.y<r&&(r=t.y);t.x>u&&(u=t.x);t.y>f&&(f=t.y)})}),{x1:i,y1:r,x2:i,y2:f,x3:u,y3:r,x4:u,y4:f,xc:i+(u-i)/2,yc:r+(f-r)/2}};t.getrotatedcoords=function(n){var i=t.getcoords(n),r=calc.rotatePoint(i.x1,i.y1,n.x,n.y,-n.rotation),u=calc.rotatePoint(i.x2,i.y2,n.x,n.y,-n.rotation),f=calc.rotatePoint(i.x3,i.y3,n.x,n.y,-n.rotation),e=calc.rotatePoint(i.x4,i.y4,n.x,n.y,-n.rotation);return{x1:r.x,y1:r.y,x2:u.x,y2:u.y,x3:f.x,y3:f.y,x4:e.x,y4:e.y,xc:i.xc,yc:i.yc}};t.getselfrotatedcoords=function(n){var i=t.getcoords(n),r=calc.rotatePoint(i.x1,i.y1,n.x,n.y,-n.rotation),u=calc.rotatePoint(i.x2,i.y2,n.x,n.y,-n.rotation),f=calc.rotatePoint(i.x3,i.y3,n.x,n.y,-n.rotation),e=calc.rotatePoint(i.x4,i.y4,n.x,n.y,-n.rotation),r=calc.rotatePoint(r.x,r.y,t.x,t.y,+t.rotation),u=calc.rotatePoint(u.x,u.y,t.x,t.y,+t.rotation),f=calc.rotatePoint(f.x,f.y,t.x,t.y,+t.rotation),e=calc.rotatePoint(e.x,e.y,t.x,t.y,+t.rotation);return{x1:r.x,y1:r.y,x2:u.x,y2:u.y,x3:f.x,y3:f.y,x4:e.x,y4:e.y}};t.updateselectionborder=function(){if(t.target.length==1)t.target[0]instanceof Text?(t.selectionborderw=0,t.selectionbordery=0):t.selectionborderw=5;else{var n=!1,i=.5;$.each(t.target,function(t,r){r instanceof Text&&(n=!0,r.scalex>i&&(i=r.scalex))});n?(t.selectionborderw=0,t.selectionbordery=0):t.selectionborderw=5}};t.gettargetdata=function(){var n;t.updateselectionborder();t.target.length==1?(t.rotation=t.target[0].rotation,n=t.getsingleclipdata(t.target)):n=t.getclipdata(t.target);t.updateselectionborder();t.width=n.width+t.selectionborderw*2;t.height=n.height+t.selectionborderh*2;t.x=n.x;t.y=n.y;t.target.length==1&&t.target[0]instanceof Text&&t.getcurveddata()};t.gettargetscaledata=function(){var n=t.drawningboard.width,i=t.drawningboard.height,r=0,u=0;$.each(t.target,function(f,e){var o=t.getselfrotatedcoords(e),s=[];s.push({x:o.x1,y:o.y1});s.push({x:o.x2,y:o.y2});s.push({x:o.x3,y:o.y3});s.push({x:o.x4,y:o.y4});$.each(s,function(t,f){f.x<n&&(n=f.x);f.y<i&&(i=f.y);f.x>r&&(r=f.x);f.y>u&&(u=f.y)})});t.updateselectionborder();t.width=r-n+t.selectionborderw*2;t.height=u-i+t.selectionborderh*2;t.target.length==1&&t.target[0]instanceof Text&&t.getcurveddata()};t.getcurveddata=function(){var n=t.target[0];if(n.flipx||n.flipy)var i=calc.rotatePoint(n.curvedline.left.x,n.curvedline.left.y,n.width/2,n.height/2,-180),r=calc.rotatePoint(n.curvedline.anchorleft.x,n.curvedline.anchorleft.y,n.width/2,n.height/2,-180),u=calc.rotatePoint(n.curvedline.anchorright.x,n.curvedline.anchorright.y,n.width/2,n.height/2,-180),f=calc.rotatePoint(n.curvedline.right.x,n.curvedline.right.y,n.width/2,n.height/2,-180);n.flipx?(t.selector.curvedleft.x=i.x*n.scalex+t.selectionborderw,t.selector.curvedanchorleft.x=r.x*n.scalex+t.selectionborderw,t.selector.curvedanchorright.x=u.x*n.scalex+t.selectionborderw,t.selector.curvedright.x=f.x*n.scalex+t.selectionborderw):(t.selector.curvedleft.x=n.curvedline.left.x*n.scalex+t.selectionborderw,t.selector.curvedanchorleft.x=n.curvedline.anchorleft.x*n.scalex+t.selectionborderw,t.selector.curvedanchorright.x=n.curvedline.anchorright.x*n.scalex+t.selectionborderw,t.selector.curvedright.x=n.curvedline.right.x*n.scalex+t.selectionborderw);n.flipy?(t.selector.curvedleft.y=i.y*n.scaley+t.selectionborderh,t.selector.curvedanchorleft.y=r.y*n.scaley+t.selectionborderh,t.selector.curvedanchorright.y=u.y*n.scaley+t.selectionborderh,t.selector.curvedright.y=f.y*n.scaley+t.selectionborderh):(t.selector.curvedleft.y=n.curvedline.left.y*n.scaley+t.selectionborderh,t.selector.curvedanchorleft.y=n.curvedline.anchorleft.y*n.scaley+t.selectionborderh,t.selector.curvedanchorright.y=n.curvedline.anchorright.y*n.scaley+t.selectionborderh,t.selector.curvedright.y=n.curvedline.right.y*n.scaley+t.selectionborderh)};t.getsingleclipdata=function(n){var i=t.drawningboard.width,r=t.drawningboard.height,u=0,f=0;return $.each(n,function(n,e){var o=t.getcoords(e),s=[];s.push({x:o.x1,y:o.y1});s.push({x:o.x2,y:o.y2});s.push({x:o.x3,y:o.y3});s.push({x:o.x4,y:o.y4});$.each(s,function(n,t){t.x<i&&(i=t.x);t.y<r&&(r=t.y);t.x>u&&(u=t.x);t.y>f&&(f=t.y)})}),{width:parseInt(u-i),height:parseInt(f-r),x:parseInt(i+(u-i)/2),y:parseInt(r+(f-r)/2),x1:parseInt(i),y1:parseInt(r)}};t.getclipdata=function(n){var i=t.drawningboard.width,r=t.drawningboard.height,u=0,f=0;return $.each(n,function(n,e){var o=t.getrotatedcoords(e),s=[];s.push({x:o.x1,y:o.y1});s.push({x:o.x2,y:o.y2});s.push({x:o.x3,y:o.y3});s.push({x:o.x4,y:o.y4});$.each(s,function(n,t){t.x<i&&(i=t.x);t.y<r&&(r=t.y);t.x>u&&(u=t.x);t.y>f&&(f=t.y)})}),{width:parseInt(u-i),height:parseInt(f-r),x:parseInt(i+(u-i)/2),y:parseInt(r+(f-r)/2),x1:parseInt(i),y1:parseInt(r)}};t.selectall=function(){t.target=[];$.each(t.drawningboard.cliplist,function(n,i){i.enabled()&&t.target.push(i)});t.rotation=0;t.select(t.target,1)};t.unsetoffset=function(){t.target!=undefined&&(t.target instanceof Array?$.each(t.target,function(n,t){t.offset.x=0;t.offset.y=0}):(t.target.offset.x=0,t.target.offset.y=0))};t.setoffset=function(n){t.offset=t.getoffset(t,n);$.each(t.target,function(i,r){r.offset=t.getoffset(r,n)})};t.workspacemove=function(n){var h,v,d,r,y,u,f,p;if(n.preventDefault?n.preventDefault():n.returnValue=!1,h=t.getclick(n),!t.contextaction&&!t.drawningboard.messagemenu)if(t.target.length>0&&t.dragging)t.settargetposition(t.target,h.x,h.y);else if(t.multiselection)t.multicoords.x2=h.x,t.multicoords.y2=h.y,t.width=Math.abs(t.multicoords.x2-t.multicoords.x1),t.height=Math.abs(t.multicoords.y2-t.multicoords.y1),t.x=t.multicoords.x2>t.multicoords.x1?t.multicoords.x1:t.multicoords.x2,t.y=t.multicoords.y2>t.multicoords.y1?t.multicoords.y1:t.multicoords.y2,t.update();else if(t.scaling){t.selected=!0;var u=t.x,f=t.y,o=t.width,s=t.height,a=calc.rotatePoint(t.relativemeasures.resizerelopx,t.relativemeasures.resizerelopy,t.relativemeasures.xc,t.relativemeasures.yc,t.rotation),i=calc.rotatePoint(h.x,h.y,t.relativemeasures.xc,t.relativemeasures.yc,t.rotation),g=calc.getDistance(i.x,i.y,a.x,a.y),nt=Math.ceil(Math.abs(i.x-a.x)),tt=Math.ceil(Math.abs(i.y-a.y)),w=g/(t.relativemeasures.distance*2),c=nt/t.relativemeasures.width,l=tt/t.relativemeasures.height,e=!0,b=!0,k=!0;t.relativemeasures.resize.type=="corner"?(n.shiftKey||(c=w,l=w),o=Math.ceil(t.relativemeasures.width*c),s=Math.ceil(t.relativemeasures.height*l),t.relativemeasures.resize.name=="nw"?(u=t.relativemeasures.resizeopx-o/2,f=t.relativemeasures.resizeopy-s/2,n.shiftKey?(i.x>t.relativemeasures.resizeopx||i.y>t.relativemeasures.resizeopy)&&(e=!1):i.x>t.relativemeasures.resizeopx&&i.y>t.relativemeasures.resizeopy&&(e=!1)):t.relativemeasures.resize.name=="sw"?(u=t.relativemeasures.resizeopx-o/2,f=t.relativemeasures.resizeopy+s/2,n.shiftKey?(i.x>t.relativemeasures.resizeopx||i.y<t.relativemeasures.resizeopy)&&(e=!1):i.x>t.relativemeasures.resizeopx&&i.y<t.relativemeasures.resizeopy&&(e=!1)):t.relativemeasures.resize.name=="ne"?(u=t.relativemeasures.resizeopx+o/2,f=t.relativemeasures.resizeopy-s/2,n.shiftKey?(i.x<t.relativemeasures.resizeopx||i.y>t.relativemeasures.resizeopy)&&(e=!1):i.x<t.relativemeasures.resizeopx&&i.y>t.relativemeasures.resizeopy&&(e=!1)):t.relativemeasures.resize.name=="se"&&(u=t.relativemeasures.resizeopx+o/2,f=t.relativemeasures.resizeopy+s/2,n.shiftKey?(i.x<t.relativemeasures.resizeopx||i.y<t.relativemeasures.resizeopy)&&(e=!1):i.x<t.relativemeasures.resizeopx&&i.y<t.relativemeasures.resizeopy&&(e=!1))):t.relativemeasures.resize.type=="horizontal"?(o=Math.ceil(t.relativemeasures.width*c),b=!1,f=t.relativemeasures.resizeopy,t.relativemeasures.resize.name=="w"?(u=t.relativemeasures.resizeopx-o/2,i.x>t.relativemeasures.resizeopx&&(e=!1)):t.relativemeasures.resize.name=="e"&&(u=t.relativemeasures.resizeopx+o/2,i.x<t.relativemeasures.resizeopx&&(e=!1))):t.relativemeasures.resize.type=="vertical"&&(s=Math.ceil(t.relativemeasures.height*l),k=!1,u=t.relativemeasures.resizeopx,t.relativemeasures.resize.name=="n"?(f=t.relativemeasures.resizeopy-s/2,i.y>t.relativemeasures.resizeopy&&(e=!1)):t.relativemeasures.resize.name=="s"&&(f=t.relativemeasures.resizeopy+s/2,i.y<t.relativemeasures.resizeopy&&(e=!1)));(o!=t.width||s!=t.height)&&s>20&&o>20&&e&&(t.rotation!=0?(v=calc.rotatePoint(u,f,t.relativemeasures.xc,t.relativemeasures.yc,-t.rotation),t.x=Math.ceil(v.x),t.y=Math.ceil(v.y)):(t.x=u,t.y=f),t.width=o,t.height=s,t.update(),t.changed=1,$.each(t.target,function(n,i){k?(i.scalex=i.relativemeasures.scalex*c,i.x=t.x-i.relativemeasures.offx*c):i.x=t.x-i.relativemeasures.offx;b?(i.scaley=i.relativemeasures.scaley*l,i.y=t.y-i.relativemeasures.offy*l):i.y=t.y-i.relativemeasures.offy;i.update()}))}else t.rotating?(d=calc.getDegree(calc.getRadian(t.x,t.y,h.x,h.y)),t.settargetrotation(d),t.closetips()):t.reshaping&&(r=t.target[0],y=t.getrelativemeasures(n,t),t.relativemeasures.resize.x=t.width/2-y.curvedx,t.relativemeasures.resize.y=t.height/2-y.curvedy,u=t.relativemeasures.resize.x/r.scalex-t.selectionborderw,f=t.relativemeasures.resize.y/r.scaley-t.selectionborderh,(r.flipx||r.flipy)&&(p=calc.rotatePoint(u,f,r.width/2,r.height/2,-180),r.flipx&&(u=p.x),r.flipy&&(f=p.y)),t.relativemeasures.resize.name=="anchorright"?(r.curvedline.anchorright.x=u,r.curvedline.anchorright.y=f):t.relativemeasures.resize.name=="anchorleft"?(r.curvedline.anchorleft.x=u,r.curvedline.anchorleft.y=f):t.relativemeasures.resize.name=="right"?(r.curvedline.right.x=u,r.curvedline.right.y=f):t.relativemeasures.resize.name=="left"&&(r.curvedline.left.x=u,r.curvedline.left.y=f),t.update(),r.curvedline.enabled=!0,r.curvedline.start=!0,r.textpath.changed=!0,r.update())};t.workspacerelease=function(n){var r,i,u,f;n.preventDefault();t.update();t.unsetoffset();t.dragging=!1;t.drawningboard.workspace.attr({cursor:"auto"});t.multiselection?(t.multiselection=!1,t.target=[],r=t.explodedmode?t.explodedtarget:t.drawningboard.cliplist,$.each(r,function(n,i){t.checkoverlap(i)&&t.includetarget(i)}),t.target.length>0?t.select(t.target,1):t.unselect()):t.scaling?(t.scaling=!1,t.endtransform(),t.select(t.target,1)):t.rotating?(t.rotating=!1,t.endtransform()):t.reshaping&&(i=t.target[0],t.reshaperelease(),u=i.x,f=i.y,t.reshaperelease(),i.x=u,i.y=f,i.update(),t.gettargetdata(),t.update(),t.changed=1,t.drawningboard.contexttab.updatepreview());t.save()};t.reshaperelease=function(){var n=t.target[0],i=n.svg.node.getBBox(),r=n.group.getBBox(),e=i.x,s=e+i.width,o=i.y,h=o+i.height,c,l,u,f;$.each([n.curvedline.left.x,n.curvedline.anchorleft.x,n.curvedline.anchorright.x,n.curvedline.right.x],function(n,t){t<e&&(e=t);t>s&&(s=t)});$.each([n.curvedline.left.y,n.curvedline.anchorleft.y,n.curvedline.anchorright.y,n.curvedline.right.y],function(n,t){t<o&&(o=t);t>h&&(h=t)});c=i.width;l=i.height;u=n.flipx?(n.x-r.cx)/n.scalex:(r.cx-n.x)/n.scalex;f=n.flipy?(n.y-r.cy)/n.scaley:(r.cy-n.y)/n.scaley;n.curvedline.left.x-=u;n.curvedline.anchorleft.x-=u;n.curvedline.anchorright.x-=u;n.curvedline.right.x-=u;n.curvedline.left.y-=f;n.curvedline.anchorleft.y-=f;n.curvedline.anchorright.y-=f;n.curvedline.right.y-=f;n.x=r.cx;n.y=r.cy;n.width=c;n.height=l;n.update();t.update();t.reshaping=!1};t.contextrelease=function(){t.contextaction&&(t.contextaction=!1,t.update(),t.unsetoffset(),t.scalex=1,t.scaley=1,t.scaling?t.scaling=!1:t.rotating?t.rotating=!1:t.reshaping&&(t.reshaping=!1),t.save())};t.clippress=function(n,i){if(i.button==2){t.target.indexOf(n)!=-1&&t.selected||(t.settarget(n),t.select(t.target,1));t.contextpress(i);return}i.preventDefault?i.preventDefault():i.returnValue=!1;var r=new Date;r-t.lastclick<300&&t.targetisgroup(n)?t.startexplodedmode(n):(t.target.indexOf(n)!=-1?i.ctrlKey?(t.excludetarget(n),t.select(t.target,1)):t.selected||t.select(t.target,1):i.ctrlKey?(t.includetarget(n),t.select(t.target,1)):(t.settarget(n),t.select(t.target,1)),t.setoffset(i),t.dragging=!0);t.lastclick=r};t.backgroundpress=function(n){n.preventDefault?n.preventDefault():n.returnValue=!1;setTimeout(function(){var r=new Date,i;r-t.lastclick<300?t.explodedmode&&t.endexplodedmode():(i=t.getclick(n),t.multicoords={x1:i.x,y1:i.y,x2:i.x,y2:i.y},t.multiselection=!0,t.unselect());t.lastclick=r},1)};t.backgroundover=function(n){n.preventDefault();t.unwatchtimer();t.closetips()};t.selectorpress=function(n){if(n.button==2){t.contextpress(n);return}n.preventDefault?n.preventDefault():n.returnValue=!1;var i=new Date;i-t.lastclick<300&&t.targetisgroup(t.target[0])?t.startexplodedmode(t.target[0]):(t.setoffset(n),t.dragging=!0);t.lastclick=i};t.resizepress=function(n,i){t.closecontext();t.gettargetscaledata();t.starttransform();t.relativemeasures=t.getrelativemeasures(i,t,n);$.each(t.target,function(n,r){r.relativemeasures=t.getrelativemeasures(i,r)});t.setoffset(i);n&&t.drawningboard.workspace.attr({cursor:n.attr("cursor")});t.scaling=!0};t.reshapepress=function(n,i){i&&(i.preventDefault?i.preventDefault():i.returnValue=!1);t.target[0].rotation!=0&&t.reshapesetrotation();t.drawningboard.workspace.attr({cursor:"pointer"});t.relativemeasures=t.getrelativemeasures(i,t,n);t.reshaping=!0;t.updateselector(!1);t.update();t.drawningboard.contexttab.updatepreview()};t.reshapesetrotation=function(){var n=t.target[0],i=calc.rotatePoint(n.curvedline.left.x,n.curvedline.left.y,n.width/2,n.height/2,-n.rotation),r=calc.rotatePoint(n.curvedline.anchorleft.x,n.curvedline.anchorleft.y,n.width/2,n.height/2,-n.rotation),u=calc.rotatePoint(n.curvedline.anchorright.x,n.curvedline.anchorright.y,n.width/2,n.height/2,-n.rotation),f=calc.rotatePoint(n.curvedline.right.x,n.curvedline.right.y,n.width/2,n.height/2,-n.rotation);n.curvedline.left.x=i.x;n.curvedline.left.y=i.y;n.curvedline.anchorleft.x=r.x;n.curvedline.anchorleft.y=r.y;n.curvedline.anchorright.x=u.x;n.curvedline.anchorright.y=u.y;n.curvedline.right.x=f.x;n.curvedline.right.y=f.y;n.rotation=0;t.rotation=0;t.gettargetdata()};t.rotatehover=function(n){var r,i,u;n.preventDefault();t.starttransform();t.rotating||(r=t.getclick(n),t.closetips(),i=t.rotatetip.clone().removeAttr("id"),$("#drawningboard").append(i),i.css("left",r.x),i.css("top",r.y),u=i.find("div"),u.tooltip(),u.tooltip("open"))};t.rotatepress=function(n){n&&typeof n!="undefined"&&n.preventDefault();t.drawningboard.workspace.attr({cursor:"pointer"});t.relativemeasures=t.getrelativemeasures(n,t);$.each(t.target,function(i,r){r.relativemeasures=t.getrelativemeasures(n,r)});t.rotating=!0};t.contextpress=function(n){var i=t.getclick(n);t.contextmenu=new Contextmenu(t.drawningboard);t.contextmenu.x=i.x;t.contextmenu.y=i.y;t.contextmenu.start()};t.watchcolors=function(n){$.each(n.color.colorlist,function(n,i){var r=stringToRgba(i.color);t.drawningboard.addrecentcolor(r)})};t.watch=function(n){t.drawningboard.cliplist.push(n);t.watchcolors(n);n.group.mouseover(function(i){i.preventDefault();var r=t.target.length===1&&t.target[0]===n;r||t.selected||!n.enabled()||(t.settarget(n),t.select(t.target,0),t.hovering=!0)});n.group.touchstart(function(i){i.preventDefault();t.clippress(n,i)});n.group.mousedown(function(i){i.preventDefault();t.clippress(n,i)});t.createstatelist(n)};t.includetarget=function(n){n.groupid==0||t.explodedmode?t.target.push(n):t.target=arrayUnique(t.target.concat(t.retrievegroupelements(n)))};t.excludetarget=function(n){n.groupid==0||t.explodedmode?t.target.splice(t.target.indexOf(n),1):$.each(t.retrievegroupelements(n),function(n,i){t.target.splice(t.target.indexOf(i),1)})};t.settarget=function(n){t.target=n.groupid==0||t.explodedmode?n.groupid!=0?[n]:[n]:t.retrievegroupelements(n)};t.retrievegroupelements=function(n){var i=[];return n&&$.each(t.drawningboard.cliplist,function(t,r){r.enabled()&&r.groupid!=0&&r.groupid==n.groupid&&i.push(r)}),i};t.retrieveiconelements=function(n){var i=[];return n&&$.each(t.drawningboard.cliplist,function(t,r){r.iconname==n.iconname&&r.enabled()&&r.subid!=undefined&&i.push(r)}),i};t.retrieveotherelements=function(n){var i=[];return $.each(t.drawningboard.cliplist,function(t,r){(r.iconname!=n.iconname||n.iconname==undefined)&&i.push(r)}),i};t.backwatch=function(){t.selector.bg.touchstart(t.backgroundpress);t.selector.bg.mousedown(t.backgroundpress);t.selector.bg.mouseover(t.backgroundover);t.drawningboard.workspace.untouchmove(t.workspacemove);t.drawningboard.workspace.untouchend(t.workspacerelease);t.drawningboard.workspace.touchmove(t.workspacemove);t.drawningboard.workspace.touchend(t.workspacerelease);$(document).off("mousemove",t.workspacemove);$(document).off("mouseup",t.workspacerelease);$(document).on("mousemove",t.workspacemove);$(document).on("mouseup",t.workspacerelease);t.selector.base.touchstart(t.selectorpress);t.selector.base.mousedown(t.selectorpress);$.each([t.selector.circle_se,t.selector.circle_sw,t.selector.circle_ne,t.selector.circle_nw,t.selector.circle_s,t.selector.circle_n,t.selector.circle_w,t.selector.circle_e],function(n,i){i.touchstart(function(n){n.preventDefault();t.resizepress(i,n)});i.mousedown(function(n){n.preventDefault();t.resizepress(i,n)})});$.each([t.selector.curvedleft,t.selector.curvedanchorleft,t.selector.curvedanchorright,t.selector.curvedright],function(n,i){i.touchstart(function(n){n.preventDefault();t.reshapepress(i,n)});i.mousedown(function(n){n.preventDefault();t.reshapepress(i,n)})});t.selector.rotate.touchstart(t.rotatepress);t.selector.rotate.mouseover(t.rotatehover);t.selector.rotate.mousedown(t.rotatepress);t.createstatelist(t.drawningboard.background);t.drawningboard.background.pushstate()};t.setnewclipstate=function(n){var r=n.y,i;for(n.alpha=0,n.y=1e3,n.pushstate(),i=0;i<=t.drawningboard.currentstate;i++)n.pushstate();n.alpha=1;n.y=r};t.createstatelist=function(n){n.pushstate=function(){t.drawningboard.currentstate<n.statelist.length&&n.statelist.splice(t.drawningboard.currentstate+1);var i={x:n.x,y:n.y,scalex:n.scalex,scaley:n.scaley,alpha:n.alpha,index:n.index,flipx:n.flipx,flipy:n.flipy,color:n.color.clone(),rotation:n.rotation,groupid:n.groupid};n.format&&(i.format=n.format.clone(),i.curvedtype=n.curvedline.type,i.curvedleftx=n.curvedline.left.x,i.curvedlefty=n.curvedline.left.y,i.curvedanchorleftx=n.curvedline.anchorleft.x,i.curvedanchorlefty=n.curvedline.anchorleft.y,i.curvedanchorrightx=n.curvedline.anchorright.x,i.curvedanchorrighty=n.curvedline.anchorright.y,i.curvedrightx=n.curvedline.right.x,i.curvedrighty=n.curvedline.right.y,i.curvedx=n.curvedline.x,i.curvedy=n.curvedline.y,i.reshape=n.curvedline.enabled,i.width=n.width,i.height=n.height);n.statelist.push(i)};n.undo=function(){t.endexplodedmode();var i=n.statelist[t.drawningboard.currentstate];n.setstate(n,i,"undo")};n.redo=function(){t.endexplodedmode();var i=n.statelist[t.drawningboard.currentstate];n.setstate(n,i,"redo")};n.setstate=function(n,t,i){n.x=t.x;n.y=t.y;n.scalex=t.scalex;n.scaley=t.scaley;n.alpha=t.alpha;n.index=t.index;n.flipx=t.flipx;n.flipy=t.flipy;n.color=t.color.clone();n.rotation=t.rotation;n.groupid=t.groupid;n.format&&(n.format=t.format.clone(),n.curvedline.left.x=t.curvedleftx,n.curvedline.left.y=t.curvedlefty,n.curvedline.anchorleft.x=t.curvedanchorleftx,n.curvedline.anchorleft.y=t.curvedanchorlefty,n.curvedline.anchorright.x=t.curvedanchorrightx,n.curvedline.anchorright.y=t.curvedanchorrighty,n.curvedline.right.x=t.curvedrightx,n.curvedline.right.y=t.curvedrighty,n.curvedline.x=t.curvedx,n.curvedline.y=t.curvedy,n.curvedline.enabled=t.reshape,n.curvedline.type=t.curvedtype,n.width=t.width,n.height=t.height);n.textpath?(n.textpath.changed=!0,n.updateFont(function(){n.update(i)})):n.update(i)}};t.unwatchtimer=function(){clearTimeout(t.unselectimer);t.unselectimer=setTimeout(function(){t.selected||t.multiselection||t.unselect()},500)};t.delete=function(){if(t.closecontext(),t.target!=undefined&&t.selected){if(t.target instanceof Array&&t.target.length==0)return;if(t.deleting)return;if(t.drawningboard.ownermode&&t.drawningboard.selector.targethavecompanytext())return;t.deleting=!0;var n=new Messagebox(t.drawningboard,t.drawningboard.api.dictionary.context_delete_message,t.deleteCall,t.drawningboard.api.dictionary.yes,t.drawningboard.api.dictionary.no,t.deleteReturn);n.show()}else return};t.deleteReturn=function(){t.deleting=!1};t.deleteCall=function(){t.selected&&(t.changed=1,$.each(t.target,function(n,i){t.deleteaction(i)}),t.drawningboard.validateData(),t.refreshindex(),t.unselect(),t.save())};t.deleteaction=function(n){n.alpha=0;n.y=1e3;n.update()};t.back=function(){var r,n,i;if(t.closecontext(),t.target.sort(t.compareclip),r=0,n=t.drawningboard.cliplist.length+1,t.explodedmode){$.each(t.target,function(t,i){r<i.subid&&(r=i.subid);n>i.subid&&(n=i.subid)});var u=[],f=[],e=t.target.length;$.each(t.explodedtarget,function(t,i){n-1==i.subid&&u.push(i);n-1>i.subid&&f.push(i)});u.length>0&&($.each(f,function(n,t){t.subid=t.subid-e}),i=n-e-1,$.each(t.target,function(n,t){t.subid=i;i++}),t.refreshindex(),t.changed=1,t.save())}else{$.each(t.target,function(t,i){r<i.index&&(r=i.index);n>i.index&&(n=i.index)});var u=[],f=[],e=t.target.length;$.each(t.drawningboard.cliplist,function(t,i){n-1==i.index&&u.push(i);n-1>i.index&&f.push(i)});u.length>0&&($.each(f,function(n,t){t.index=t.index-e}),i=n-e-1,$.each(t.target,function(n,t){t.index=i;i++}),t.refreshindex(),t.changed=1,t.save())}};t.front=function(){var n,r,i;if(t.closecontext(),t.target.sort(t.compareclip),n=0,r=t.drawningboard.cliplist.length+1,t.explodedmode){$.each(t.target,function(t,i){n<i.subid&&(n=i.subid);r>i.subid&&(r=i.subid)});var u=[],f=[],e=t.target.length;$.each(t.explodedtarget,function(t,i){n+1==i.subid&&u.push(i);n+1<i.subid&&f.push(i)});u.length>0&&($.each(f,function(n,t){t.subid=t.subid+e}),i=n+2,$.each(t.target,function(n,t){t.subid=i;i++}),t.refreshindex(),t.changed=1,t.save())}else{$.each(t.target,function(t,i){n<i.index&&(n=i.index);r>i.index&&(r=i.index)});var u=[],f=[],e=t.target.length;$.each(t.drawningboard.cliplist,function(t,i){n+1==i.index&&u.push(i);n+1<i.index&&f.push(i)});u.length>0&&($.each(f,function(n,t){t.index=t.index+e}),i=n+2,$.each(t.target,function(n,t){t.index=i;i++}),t.refreshindex(),t.changed=1,t.save())}};t.backall=function(){t.closecontext();t.changed=1;t.target.sort(t.compareclip);var n=-t.target.length;t.explodedmode?$.each(t.target,function(t,i){i.subid=n;n++}):$.each(t.target,function(t,i){i.index=n;n++});t.refreshindex();t.save()};t.frontall=function(){t.closecontext();t.changed=1;t.target.sort(t.compareclip);var n=t.drawningboard.cliplist.length+1;t.explodedmode?$.each(t.target,function(t,i){i.subid=n;n++}):$.each(t.target,function(t,i){i.index=n;n++});t.refreshindex();t.save()};t.refreshindex=function(){var n=0;t.drawningboard.workspace.add(t.selector.bg);t.drawningboard.workspace.add(t.selector.lowergroup);t.drawningboard.cliplist.sort(t.compareclip);$.each(t.drawningboard.cliplist,function(i,r){r.enabled()&&(n++,r.index=n,r.update(),t.drawningboard.workspace.add(r.group))});t.drawningboard.workspace.add(t.selector.uppergroup);t.drawningboard.workspace.add(t.selector.highlightgroup);t.drawningboard.workspace.add(t.selector.multigroup);t.target.length>1&&t.drawningboard.contexttab.loadiconelements()};t.compareclip=function(n,t){return n.index<t.index?-1:n.index==t.index?n.subid<t.subid?-1:1:1};t.getnewindex=function(n){var r=0,i=0;return $.each(t.drawningboard.cliplist,function(t,u){u.enabled()&&u.index>r&&(r=u.index);u.id==n&&(i=u.index)}),i==0&&(i=r+1),i};t.flipvertical=function(){t.rotation!=0&&t.select(t.target,1);t.changed=1;t.closecontext();$.each(t.target,function(n,i){i.flipy=i.flipy==0?1:0;var r=calc.rotatePoint(i.x,i.y,t.x,t.y,180);i.rotation!=0&&(i.rotation=360-i.rotation);i.y=r.y;i.update()});t.target.length==1&&t.target[0]instanceof Text&&t.getcurveddata();t.update();t.save()};t.fliphorizontal=function(){t.rotation!=0&&t.select(t.target,1);t.changed=1;t.closecontext();$.each(t.target,function(n,i){i.flipx=i.flipx==0?1:0;var r=calc.rotatePoint(i.x,i.y,t.x,t.y,180);i.rotation!=0&&(i.rotation=360-i.rotation);i.x=r.x;i.update()});t.target.length==1&&t.target[0]instanceof Text&&t.getcurveddata();t.save()};t.upscale=function(n){n||(n=.01);t.relativeset||t.resizepress();t.scalex+=n;t.scaley+=n;t.settargetscale(t.scalex,t.scaley)};t.downscale=function(n){n||(n=.01);t.relativeset||t.resizepress();t.scalex-=n;t.scaley-=n;t.settargetscale(t.scalex,t.scaley)};t.setscale=function(n,i){t.relativeset||t.resizepress();t.settargetscale(n,i)};t.rotateleft=function(){t.relativeset||t.rotatepress();t.rotation--;t.settargetrotation(t.rotation)};t.rotateright=function(){t.relativeset||t.rotatepress();t.rotation++;t.settargetrotation(t.rotation)};t.center=function(){t.gettargetdata();var n=t.drawningboard.width/2-t.x,i=t.drawningboard.height/2-t.y;t.settargetpositionoffset(t.target,n,i)};t.moveup=function(n){t.settargetpositionoffset(t.target,0,-n)};t.movedown=function(n){t.settargetpositionoffset(t.target,0,n)};t.moveleft=function(n){t.settargetpositionoffset(t.target,-n,0)};t.moveright=function(n){t.settargetpositionoffset(t.target,n,0)};t.settargetpositionoffset=function(n,i,r){t.selected&&(t.closecontext(),t.changed=1,n instanceof Array&&($.each(n,function(n,t){t.x+=i;t.y+=r;t.update()}),t.x+=i,t.y+=r),t.update())};t.settargetposition=function(n,i,r){if(t.selected){t.closecontext();t.changed=1;var u=t.checklimits(i,r);$.each(n,function(n,t){u.x&&(t.x=i+t.offset.x);u.y&&(t.y=r+t.offset.y);t.update()});u.x&&(t.x=i+t.offset.x);u.y&&(t.y=r+t.offset.y);t.update()}};t.getcoordsoffset=function(n,t,i){return corners={x1:t+n.offset.x-n.width*n.scalex*.5,y1:i+n.offset.y-n.height*n.scaley*.5,x2:t+n.offset.x-n.width*n.scalex*.5,y2:i+n.offset.y+n.height*n.scaley*.5,x3:t+n.offset.x+n.width*n.scalex*.5,y3:i+n.offset.y-n.height*n.scaley*.5,x4:t+n.offset.x+n.width*n.scalex*.5,y4:i+n.offset.y+n.height*n.scaley*.5,xc:t+n.offset.x,yc:i+n.offset.y}};t.getrotatedcoordsoffset=function(n,i,r){var u=t.getcoordsoffset(n,i,r),f=calc.rotatePoint(u.x1,u.y1,u.xc,u.yc,-n.rotation),e=calc.rotatePoint(u.x2,u.y2,u.xc,u.yc,-n.rotation),o=calc.rotatePoint(u.x3,u.y3,u.xc,u.yc,-n.rotation),s=calc.rotatePoint(u.x4,u.y4,u.xc,u.yc,-n.rotation);return{x1:f.x,y1:f.y,x2:e.x,y2:e.y,x3:o.x,y3:o.y,x4:s.x,y4:s.y,xc:u.xc,yc:u.yc}};t.checklimits=function(n,i){var f=!0,e=!0,r=t.drawningboard.width-t.pixellimit,u=t.drawningboard.height-t.pixellimit;return $.each(t.target,function(o,s){var c=t.getrotatedcoordsoffset(s,n,i),h=[];h.x1=c.x1<t.pixellimit||c.x1>r;h.x2=c.x2<t.pixellimit||c.x2>r;h.x3=c.x3<t.pixellimit||c.x3>r;h.x4=c.x4<t.pixellimit||c.x4>r;h.xc=c.xc<t.pixellimit||c.xc>r;h.y1=c.y1<t.pixellimit||c.y1>u;h.y2=c.y2<t.pixellimit||c.y2>u;h.y3=c.y3<t.pixellimit||c.y3>u;h.y4=c.y4<t.pixellimit||c.y4>u;h.yc=c.yc<t.pixellimit||c.yc>u;h.p1=h.x1||h.y1;h.p2=h.x2||h.y2;h.p3=h.x3||h.y3;h.p4=h.x4||h.y4;h.pc=h.xc||h.yc;h.p1&&h.p2&&h.p3&&h.p4&&h.pc&&(h.x1&&h.x2&&h.x3&&h.x4&&h.xc&&(f=!1),h.y1&&h.y2&&h.y3&&h.y4&&h.yc&&(e=!1))}),{x:f,y:e}};t.settargetrotation=function(n){n<0?n+=360:n>=360&&(n-=360);t.closecontext();t.rotation=n;t.changed=1;$.each(t.target,function(i,r){r.rotation=n+r.relativemeasures.rotation-t.relativemeasures.rotation;var u=calc.rotatePoint(r.relativemeasures.xc,r.relativemeasures.yc,t.relativemeasures.xc,t.relativemeasures.yc,-n+t.relativemeasures.rotation);r.x=u.x;r.y=u.y;r.update()});t.update()};t.settargetscale=function(n,i){t.changed=1;var r=(t.relativemeasures.width-t.selectionborderw*2)*n+t.selectionborderw*2,u=(t.relativemeasures.height-t.selectionborderh*2)*i+t.selectionborderh*2;$.each(t.target,function(f,e){n&&r>=20&&(e.scalex=e.relativemeasures.scalex*n,e.x=t.x-e.relativemeasures.offx*n);i&&u>=20&&(e.scaley=e.relativemeasures.scaley*i,e.y=t.y-e.relativemeasures.offy*i);e.update()});t.gettargetscaledata();t.update()};t.reshape=function(){var n,i,r;t.drawningboard.selector.closecontext();n=t.target[0];n.curvedline.enabled?(n.curvedline.x=n.x,n.curvedline.y=n.y):n.curvedline.type="up";n.rotation=0;t.rotation=0;n.flipx=0;n.flipy=0;t.reshaperelease();i=n.x;r=n.y;t.reshaperelease();n.x=i;n.y=r;n.update();t.reshaperelease();t.gettargetdata();t.updateselector(n.curvedline.enabled);n.curvedline.enabled||(n.curvedline.start?n.curvedline.start=!1:(n.x=typeof n.curvedline.x!="undefined"?n.curvedline.x:n.x,n.y=typeof n.curvedline.y!="undefined"?n.curvedline.y:n.y,n.update(),t.gettargetdata()));t.update();t.drawningboard.contexttab.updatepreview()};t.group=function(){if(t.target.length==1)t.target[0].groupid=0,t.changed=!0,t.save(),t.select(t.target,1);else{var n=!1,i=0;$.each(t.target,function(t,r){if(r.groupid==0){n=!0;return}if(r.groupid!=0&&r.groupid!=i&&i!=0){n=!0;return}i==r.groupid});n?(t.drawningboard.groupid++,$.each(t.target,function(n,i){i.groupid=t.drawningboard.groupid}),t.changed=!0,t.save(),t.select(t.target,1)):($.each(t.target,function(n,t){t.groupid=0}),t.changed=!0,t.save(),t.unselect())}};t.copycolors=function(){var n=t.target[0];t.colorcopytarget=n.color.clone()};t.pastecolors=function(){t.closecontext();t.colorcopytarget&&($.each(t.target,function(n,i){i.color=t.colorcopytarget.clone();i.update()}),t.update(),t.drawningboard.contexttab.select(t.target),t.changed=1,t.save())};t.copy=function(){t.selected?(t.copytarget=t.target,t.pastecount=1):t.copytarget=[]};t.paste=function(){var n,i,r,u;t.copytarget.length!=0&&(n=[],t.explodedmode?(i=0,$.each(t.explodedtarget,function(n,t){t.subid>i&&(i=t.subid)}),$.each(t.copytarget,function(r,u){if(u instanceof Clip){i++;var f=new Clip(u.path,u.color.clone(),t.drawningboard);f.x=u.x+20*t.pastecount;f.y=u.y+20*t.pastecount;f.realposition=!0;f.id=u.id;f.subid=i;f.scalex=u.scalex;f.scaley=u.scaley;f.rotation=u.rotation;f.flipx=u.flipx;f.flipy=u.flipy;f.start();t.explodedtarget.push(f);t.setnewclipstate(f);n.push(f)}else u instanceof Text&&(i++,f=new Text(u.format.text,u.format.font,u.scale,u.color.clone(),t.drawningboard,u.x+20*t.pastecount,u.y+20*t.pastecount,u.id),f.subid=i,f.format=u.format.clone(),f.rotation=u.rotation,f.flipx=u.flipx,f.flipy=u.flipy,f.scalex=u.scalex,f.scaley=u.scaley,f.realposition=!0,f.width=u.width,f.height=u.height,f.curvedline.enabled=u.curvedline.enabled,f.curvedline.startheight=u.curvedline.startheight,f.curvedline.startwidth=u.curvedline.startwidth,f.curvedline.left.x=u.curvedline.left.x,f.curvedline.left.y=u.curvedline.left.y,f.curvedline.anchorleft.x=u.curvedline.anchorleft.x,f.curvedline.anchorleft.y=u.curvedline.anchorleft.y,f.curvedline.anchorright.x=u.curvedline.anchorright.x,f.curvedline.anchorright.y=u.curvedline.anchorright.y,f.curvedline.right.x=u.curvedline.right.x,f.curvedline.right.y=u.curvedline.right.y,f.curvedline.type=u.curvedline.type,f.start(),t.explodedtarget.push(f),t.setnewclipstate(f),n.push(f))})):(r=[],$.each(t.copytarget,function(i,r){if(r instanceof Clip){t.drawningboard.clipid++;var u=new Clip(r.path,r.color.clone(),t.drawningboard);u.x=r.x+20*t.pastecount;u.y=r.y+20*t.pastecount;u.realposition=!0;u.id=t.drawningboard.clipid;u.scalex=r.scalex;u.scaley=r.scaley;u.rotation=r.rotation;u.flipx=r.flipx;u.flipy=r.flipy;u.start();t.setnewclipstate(u);n.push(u)}else r instanceof Text&&(t.drawningboard.clipid++,u=new Text(r.format.text,r.format.font,r.scale,r.color.clone(),t.drawningboard,r.x+20*t.pastecount,r.y+20*t.pastecount,t.drawningboard.clipid),u.format=r.format.clone(),u.rotation=r.rotation,u.flipx=r.flipx,u.flipy=r.flipy,u.scalex=r.scalex,u.scaley=r.scaley,u.realposition=!0,u.reshape=r.reshape,u.width=r.width,u.height=r.height,u.oldWidth=r.oldWidth,u.oldHeight=r.oldHeight,u.curvedline.enabled=r.curvedline.enabled,u.curvedline.x=r.curvedline.x,u.curvedline.y=r.curvedline.y,u.curvedline.startheight=r.curvedline.startheight,u.curvedline.startwidth=r.curvedline.startwidth,u.curvedline.left.x=r.curvedline.left.x,u.curvedline.left.y=r.curvedline.left.y,u.curvedline.anchorleft.x=r.curvedline.anchorleft.x,u.curvedline.anchorleft.y=r.curvedline.anchorleft.y,u.curvedline.anchorright.x=r.curvedline.anchorright.x,u.curvedline.anchorright.y=r.curvedline.anchorright.y,u.curvedline.right.x=r.curvedline.right.x,u.curvedline.right.y=r.curvedline.right.y,u.curvedline.type=r.curvedline.type,u.start(),t.setnewclipstate(u),n.push(u))}),$.each(r,function(i,r){if(u!=r.id&&t.drawningboard.clipid++,u=r.id,r instanceof Clip){var f=new Clip(r.path,r.color.clone(),t.drawningboard);f.x=r.x+20*t.pastecount;f.y=r.y+20*t.pastecount;f.realposition=!0;f.id=t.drawningboard.clipid;f.subid=r.subid;f.scalex=r.scalex;f.scaley=r.scaley;f.rotation=r.rotation;f.flipx=r.flipx;f.flipy=r.flipy}else r instanceof Text&&(f=new Text(r.format.text,r.format.font,r.scale,r.color.clone(),t.drawningboard,r.x+20*t.pastecount,r.y+20*t.pastecount,t.drawningboard.clipid),f.format.size=r.format.size,f.rotation=r.rotation,f.format.bold=r.format.bold,f.format.italic=r.format.italic,f.flipx=r.flipx,f.flipy=r.flipy,f.scalex=r.scalex,f.scaley=r.scaley,f.subid=r.subid,f.realposition=!0,f.reshape=r.reshape,f.width=r.width,f.height=r.height,f.curvedline.enabled=r.curvedline.enabled,f.curvedline.startheight=r.curvedline.startheight,f.curvedline.startwidth=r.curvedline.startwidth,f.curvedline.left.x=r.curvedline.left.x,f.curvedline.left.y=r.curvedline.left.y,f.curvedline.anchorleft.x=r.curvedline.anchorleft.x,f.curvedline.anchorleft.y=r.curvedline.anchorleft.y,f.curvedline.anchorright.x=r.curvedline.anchorright.x,f.curvedline.anchorright.y=r.curvedline.anchorright.y,f.curvedline.right.x=r.curvedline.right.x,f.curvedline.right.y=r.curvedline.right.y,f.curvedline.type=r.curvedline.type);f.start();t.setnewclipstate(f);n.push(f)})),t.changed=1,t.save(),t.pastecount++,t.target=n,setTimeout(function(){t.refreshindex();t.select(t.target,!0)},100))};t.getrelativemeasures=function(n,i,r){t.relativeset=1;var f=t.getclick(n),s=t.getcoords(i),u=t.getrotatedcoords(i),h=calc.rotatePoint(f.x,f.y,t.x,t.y,t.rotation);if(r)var c=calc.getRadianFromDegree(calc.fixDegree(r.angle)),l=r.xfactor*t.width+s.x1,a=r.yfactor*t.height+s.y1,e=calc.rotatePoint(l,a,u.xc,u.yc,180),o=calc.rotatePoint(l,a,u.xc,u.yc,180-t.rotation);return{width:i.width,height:i.height,distance:n?calc.getDistance(u.xc,u.yc,f.x,f.y):0,distancex:Math.abs(u.xc-f.x),distancey:Math.abs(u.yc-f.y),clickradian:calc.getRadian(u.xc,u.yc,f.x,f.y),resizeradian:c?c:0,resizeopx:e?Math.ceil(e.x):0,resizeopy:e?Math.ceil(e.y):0,resizerelopx:o?Math.ceil(o.x):0,resizerelopy:o?Math.ceil(o.y):0,curvedx:u.xc-h.x,curvedy:u.yc-h.y,distancenw:n?calc.getDistance(u.x1,u.y1,f.x,f.y):0,distancesw:n?calc.getDistance(u.x2,u.y2,f.x,f.y):0,distancene:n?calc.getDistance(u.x3,u.y3,f.x,f.y):0,distancese:n?calc.getDistance(u.x4,u.y4,f.x,f.y):0,x:u.x1,y:u.y1,xc:u.xc,yc:u.yc,coords:u,scalex:i.scalex,scaley:i.scaley,resize:r,offx:t.x-u.xc,offy:t.y-u.yc,rotation:i.rotation}};t.getoffset=function(n,i){var r=t.getclick(i),u=t.getcoords(n);return{x:i?u.xc-r.x:0,y:i?u.yc-r.y:0}};t.getclick=function(n){return typeof n!="undefined"&&n.type&&n.type.indexOf("touch")===0?{x:n?n.touches[0].pageX-t.drawningboard.position.left:0,y:n?n.touches[0].pageY-t.drawningboard.position.top:0}:{x:n?n.clientX-t.drawningboard.position.left:0,y:n?n.clientY-t.drawningboard.position.top:0}};t.starttransform=function(){t.selected?t.moveselected=!0:(t.moveselected=!1,t.selected=!0)};t.endtransform=function(){t.selected=t.moveselected;t.unwatchtimer()};t.start()}