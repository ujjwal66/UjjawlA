SaveDialog=function(n){var t=this;t.drawningboard=n;t.dom;t.status;t.type;t.category;t.callback;t.success=!1;t.show=function(){t.loadOwnerSaveDialog(function(n){t.dom=$(n);$("#logobody").append(t.dom);t.dom.hide();t.dom.fadeIn(200);t.drawningboard.messagemenu=t;t.loadcategories()})};t.loadOwnerSaveDialog=function(n){$.ajax({type:"GET",url:"/ownersavedialog"}).done(n)};t.loadcategories=function(){$.ajax({type:"post",url:t.drawningboard.api.category+"list",dataType:"json"}).done(function(n){$.each(n.obj,function(n,i){i.description=t.drawningboard.api.dictionary["category_"+i.id];i.description==undefined&&(i.description="undefined")});var i=n.obj;i.sort(function(n,t){return n.description.toUpperCase()>t.description.toUpperCase()?1:n.description<t.description?-1:void 0});t.objcategorylist=i;t.status=t.dom.find(".status select");t.type=t.dom.find(".type select");t.category=t.dom.find(".category select");t.registerevents();$.each(t.objcategorylist,function(n,i){var r=$("<option>"+i.description+"<\/option>");r.attr("value",i.id);t.category.append(r);i.subcategory&&$.each(i.subcategory,function(n,i){var r=$("<option>- "+i.description+"<\/option>");r.attr("value",i.id);t.category.append(r)})})})};t.registerevents=function(){t.dom.find(".close, .cancel").on("mouseup",t.hide);t.dom.find(".add").on("mouseup",t.save);t.type.on("change",function(){$(this).val()==1?t.category.removeAttr("disabled"):t.category.attr("disabled","disabled")})};t.save=function(){t.type.val()==1?t.saveicon():t.saveshape()};t.geticondata=function(n){var e,u,f;typeof n=="undefined"&&(n=!1);e=[];$.each(t.drawningboard.cliplist,function(n,t){!t.companytext&&t.enabled()&&e.push(t)});var r=t.drawningboard.selector.getclipdata(e),i={},s=!1,o=.5;return $.each(t.drawningboard.cliplist,function(n,t){t instanceof Text&t.enabled()&&(s=!0,t.scalex>o&&(o=t.scalex))}),u=s?90*o:0,i.width=n?parseInt(r.width):parseInt(r.width+u*2+40),i.height=parseInt(r.height),i.dominant_color=t.getDominantColor(),t.drawningboard.showbackground&&(i.background_color=t.drawningboard.background.color.colorlist[0].color),i.category_list=[],i.shape_list=[],i.text_list=[],i.owner_id=t.drawningboard.ownerid,i.logo_source_id=t.drawningboard.logosourceid,i.category_source_id=t.drawningboard.categorysourceid,f=1,$.each(t.drawningboard.cliplist,function(n,t){if(t instanceof Clip&&t.enabled()){var e=t.svg,o=$(e.node).clone().wrap("<div><\/div>").parent().html().replaceAll("'","");i.shape_list.push({svg:o,color:JSON.stringify(t.color),offset_x:t.x-r.x1+u,offset_y:t.y-r.y1,scale_x:t.scalex,scale_y:t.scaley,index:f,flip_x:t.flipx,flip_y:t.flipy,width:parseInt(t.width),height:parseInt(t.height),rotation:t.rotation,note:t.note,noun_id:t.nounId,group_id:t.groupid});f++}else t instanceof Text&&t.enabled()&&!t.companytext&&(t.format.font==undefined&&(t.format.font=Textformat.defaultFont),typeof t.format.font!="undefined"&&t.format.font!=null&&(t.format.font=t.format.font.replace(/['"]+/g,"")),t.format.font=t.format.font.replace("'","").replace("'",""),i.text_list.push({format:JSON.stringify(t.format),color:JSON.stringify(t.color),flip_x:t.flipx,flip_y:t.flipy,offset_x:t.x-r.x1+u,offset_y:t.y-r.y1,rotation:t.rotation,scale_x:t.scalex,scale_y:t.scaley,width:parseInt(t.width),height:parseInt(t.height),curvedline:JSON.stringify(t.curvedline),index:f,group_id:t.groupid,letterspacing:t.letterspacing}),f++)}),i};t.getDominantColor=function(){var n=[];if($.each(t.drawningboard.cliplist,function(t,i){if(i.enabled()){var r=parseInt(i.width*i.scalex*i.height*i.scaley/i.color.colorlist.length);$.each(i.color.colorlist,function(t,i){if(i.color!="rgba(255,255,255,1)"){var u=undefined;$.each(n,function(n,t){i.color==t.color&&(u=t)});u?u.area=u.area+r:n.push({color:i.color,area:r})}})}}),n.sort(function(n,t){return n.area<t.area?1:-1}),n.length>0)return n[0].color;undefined};t.saveicon=function(){var n=t.geticondata(),i,r;if(n.status=t.status.val(),n.category_list.push({id:t.category.val()}),n.engine=t.drawningboard.engine,n.shape_list.length==0){i=new Messagebox(t.drawningboard,t.drawningboard.api.dictionary.savedialog_icon_no_shape,null,null,t.drawningboard.api.dictionary.ok);i.show();return}t.drawningboard.startloading();r={logo:n,loginKey:t.drawningboard.ownerloginkey,oldid:t.drawningboard.editiconid};$.ajax({type:"post",url:t.drawningboard.api.logo+"insert",data:JSON.stringify(r),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(n){var i;if(t.drawningboard.endloading(),n.status==1){t.success=!0;i=new Messagebox(t.drawningboard,t.drawningboard.api.dictionary.savedialog_icon_success,null,null,t.drawningboard.api.dictionary.ok,t.hide);i.show();t.drawningboard.reset();return}i=new Messagebox(t.drawningboard,n.Message,null,null,"ok");i.show()})};t.saveshape=function(){var n=t.geticondata(!0),i,r;if(n.status=t.status.val(),n.shape_list.length==0){i=new Messagebox(t.drawningboard,t.drawningboard.api.dictionary.savedialog_shape_empty,null,null,t.drawningboard.api.dictionary.ok);i.show();return}t.drawningboard.startloading();r={shapes:n,loginKey:t.drawningboard.ownerloginkey};$.ajax({type:"post",url:t.drawningboard.api.shape+"insert",data:JSON.stringify(r),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(n){var i;if(t.drawningboard.endloading(),n.status==1){t.success=!0;i=new Messagebox(t.drawningboard,t.drawningboard.api.dictionary.savedialog_shape_success,null,null,t.drawningboard.api.dictionary.ok,t.hide);i.show();t.drawningboard.reset();return}i=new Messagebox(t.drawningboard,n.Message,null,null,t.drawningboard.api.dictionary.ok);i.show()})};t.hide=function(){t.dom&&t.dom.fadeOut(200,function(){t.dom.remove()});t.drawningboard.messagemenu=undefined;t.success&&t.callback&&(t.success=!1,t.callback())}}